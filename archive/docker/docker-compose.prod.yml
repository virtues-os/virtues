version: '3.8'

# Production override - use with:
# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  minio:
    restart: always

  core:
    build:
      context: ./core
      dockerfile: Dockerfile
      target: ""  # Use default (production) target
    restart: always
    # Remove development volumes, keep sqlite data
    volumes:
      - sqlite_data:/data
    environment:
      DATABASE_URL: sqlite:/data/virtues.db
      VIRTUES_ENCRYPTION_KEY: ${VIRTUES_ENCRYPTION_KEY}
      RUST_LOG: info,virtues=info
      # OAuth endpoints
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      NOTION_CLIENT_ID: ${NOTION_CLIENT_ID}
      NOTION_CLIENT_SECRET: ${NOTION_CLIENT_SECRET}
      # MinIO connection
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: virtues-data
    # Production health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      target: production
    restart: always
    # Remove development volumes
    volumes: []
    environment:
      ELT_API_URL: http://core:8000
      PUBLIC_ELT_API_URL: ${PUBLIC_ELT_API_URL:-http://localhost:8000}
      NODE_ENV: production
    ports:
      - "3000:3000"
    # Override command for production
    command: node build

volumes:
  sqlite_data:
    driver: local
  minio_data:
    driver: local

networks:
  virtues-network:
    driver: bridge
