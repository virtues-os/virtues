name: Release Mac CLI

on:
  push:
    tags:
      - 'mac-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/mac-v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "No certificate provided, skipping import"
            exit 0
          fi

          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 -d > certificate.p12
          security import certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          # Set as default keychain and add to search list
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"

          # Allow codesign to access the key without prompting
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Clean up
          rm certificate.p12

          # Export keychain path and password for subsequent steps
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          # Verify certificate is accessible for code signing
          echo "Verifying certificate is accessible..."
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo "Certificate imported successfully"
      
      - name: Build universal binary
        env:
          CODESIGN_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          # Debug: Show what env vars are available
          echo "KEYCHAIN_PATH from GITHUB_ENV: ${KEYCHAIN_PATH:-<not set>}"
          echo "KEYCHAIN_PASSWORD length: ${#KEYCHAIN_PASSWORD}"
          cd apps/mac

          # Build for x86_64
          xcodebuild -project mac.xcodeproj \
            -scheme mac \
            -configuration Release \
            -arch x86_64 \
            -derivedDataPath .build/x86_64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

          # Build for arm64
          xcodebuild -project mac.xcodeproj \
            -scheme mac \
            -configuration Release \
            -arch arm64 \
            -derivedDataPath .build/arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

          # Find the built binaries
          X86_BINARY=$(find .build/x86_64 -name "mac" -type f -perm +111 | head -1)
          ARM_BINARY=$(find .build/arm64 -name "mac" -type f -perm +111 | head -1)

          echo "x86_64 binary: $X86_BINARY"
          echo "arm64 binary: $ARM_BINARY"

          # Create universal binary
          lipo -create "$X86_BINARY" "$ARM_BINARY" -output virtues-mac

          # Make it executable
          chmod +x virtues-mac

          # Strip debug symbols
          strip virtues-mac

          # Sign if certificate is available
          if [ -n "$CODESIGN_IDENTITY" ] && [ -n "$KEYCHAIN_PATH" ]; then
            echo "Signing with identity: $CODESIGN_IDENTITY"

            # Unlock keychain for this step
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

            # Verify certificate is still accessible
            echo "Available signing identities:"
            security find-identity -v -p codesigning "$KEYCHAIN_PATH"

            # Sign with explicit keychain
            codesign --force --deep \
                     --sign "$CODESIGN_IDENTITY" \
                     --keychain "$KEYCHAIN_PATH" \
                     --options runtime \
                     --timestamp \
                     virtues-mac || { echo "ERROR: codesign failed!"; exit 1; }

            # Verify signature
            codesign --verify --verbose virtues-mac || { echo "ERROR: signature verification failed!"; exit 1; }
            echo "Binary signed successfully"
          else
            echo "No signing identity provided, binary will be unsigned"
            echo "CODESIGN_IDENTITY: ${CODESIGN_IDENTITY:-<empty>}"
            echo "KEYCHAIN_PATH: ${KEYCHAIN_PATH:-<empty>}"
          fi

          # Verify universal binary
          echo "Binary architectures:"
          lipo -info virtues-mac

          # Create tarball
          tar -czf virtues-mac-${{ steps.version.outputs.VERSION }}-universal.tar.gz virtues-mac

          # Create zip for easier download
          zip virtues-mac-${{ steps.version.outputs.VERSION }}-universal.zip virtues-mac
      
      - name: Notarize Binary
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd apps/mac

          # Check if we have notarization credentials
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_APP_PASSWORD" ]; then
            echo "No notarization credentials provided, skipping"
            exit 0
          fi

          # Only notarize if signed
          if codesign -dv virtues-mac 2>&1 | grep -q "Authority"; then
            echo "Submitting for notarization..."

            # Create zip for notarization using ditto (required for CLI tools)
            ditto -c -k --keepParent virtues-mac virtues-mac-notarize.zip

            # Submit for notarization
            xcrun notarytool submit virtues-mac-notarize.zip \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait

            # Note: stapler doesn't work on bare binaries (only app bundles/DMGs)
            # The notarization ticket is stored in Apple's servers and checked at runtime

            # Recreate archives with notarized binary
            tar -czf virtues-mac-${{ steps.version.outputs.VERSION }}-universal.tar.gz virtues-mac
            zip virtues-mac-${{ steps.version.outputs.VERSION }}-universal.zip virtues-mac

            echo "Notarization complete"
          else
            echo "Binary not signed, skipping notarization"
          fi
      
      - name: Copy installer scripts
        run: |
          # Copy the enhanced installer with GUI
          cp apps/mac/Scripts/installer.sh installer.sh
          chmod +x installer.sh
          
          # Create simple install script for backward compatibility
          cat > install-simple.sh << 'EOF'
          #!/bin/bash
          set -e
          
          VERSION="${1:-latest}"
          INSTALL_DIR="/usr/local/bin"
          
          echo "Installing virtues-mac $VERSION..."
          
          # Detect architecture
          ARCH=$(uname -m)
          echo "Detected architecture: $ARCH"
          
          # Download URL
          if [ "$VERSION" = "latest" ]; then
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/mac-latest/virtues-mac-universal.tar.gz"
          else
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/mac-v$VERSION/virtues-mac-$VERSION-universal.tar.gz"
          fi
          
          # Download and extract
          echo "Downloading from $DOWNLOAD_URL..."
          curl -L -o /tmp/virtues-mac.tar.gz "$DOWNLOAD_URL"
          tar -xzf /tmp/virtues-mac.tar.gz -C /tmp/
          
          # Install binary
          echo "Installing to $INSTALL_DIR..."
          sudo mv /tmp/virtues-mac "$INSTALL_DIR/virtues-mac"
          sudo chmod +x "$INSTALL_DIR/virtues-mac"
          
          # Clean up
          rm -f /tmp/virtues-mac.tar.gz
          
          echo "âœ… Installation complete!"
          echo ""
          echo "Run 'virtues-mac --help' to get started"
          echo ""
          echo "Quick start:"
          echo "  1. Get a device token from https://virtues.com"
          echo "  2. Run: virtues-mac init <token>"
          echo "  3. Run: virtues-mac daemon"
          EOF
          
          chmod +x install-simple.sh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Mac CLI v${{ steps.version.outputs.VERSION }}
          body: |
            ## Virtues Mac CLI v${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            #### Option 1: Interactive Installer (Recommended)
            ```bash
            # With GUI dialogs and automatic setup
            curl -sSL https://github.com/${{ github.repository }}/releases/latest/download/installer.sh | bash
            ```
            
            #### Option 2: Quick Install with Parameters
            ```bash
            # Provide token and endpoint directly
            curl -sSL https://github.com/${{ github.repository }}/releases/latest/download/installer.sh | \
              bash -s -- --token YOUR_TOKEN --endpoint https://your-server.com
            ```
            
            #### Option 3: Manual Download
            1. Download `virtues-mac-${{ steps.version.outputs.VERSION }}-universal.tar.gz`
            2. Extract: `tar -xzf virtues-mac-*.tar.gz`
            3. Move to PATH: `sudo mv virtues-mac /usr/local/bin/`
            4. Make executable: `sudo chmod +x /usr/local/bin/virtues-mac`
            
            ### Usage
            ```bash
            # Initialize with token from web UI
            virtues-mac init <token>
            
            # Install as background service (auto-starts on login)
            virtues-mac daemon
            
            # Check status
            virtues-mac status
            
            # Stop service
            virtues-mac stop
            ```
            
            ### What's New
            - Universal binary (Intel + Apple Silicon)
            - Automatic startup on login
            - Simplified data collection (app focus events only)
            - 5-minute batch uploads
            - Local SQLite queue for reliability
            
            ### Requirements
            - macOS 11.0 or later
            - Accessibility permissions (prompted on first run)
          files: |
            apps/mac/virtues-mac-${{ steps.version.outputs.VERSION }}-universal.tar.gz
            apps/mac/virtues-mac-${{ steps.version.outputs.VERSION }}-universal.zip
            installer.sh
            install-simple.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest release
        if: success()
        run: |
          # Copy files for latest tag
          cd apps/mac
          cp virtues-mac-${{ steps.version.outputs.VERSION }}-universal.tar.gz virtues-mac-universal.tar.gz
          cp virtues-mac-${{ steps.version.outputs.VERSION }}-universal.zip virtues-mac-universal.zip
      
      - name: Upload latest artifacts
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mac-latest
          name: Mac CLI Latest
          body: |
            This release is automatically updated with the latest stable version.
            Current version: v${{ steps.version.outputs.VERSION }}
            
            For specific versions, see [all releases](https://github.com/${{ github.repository }}/releases).
          files: |
            apps/mac/virtues-mac-universal.tar.gz
            apps/mac/virtues-mac-universal.zip
            installer.sh
            install-simple.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}