name: Release Mac App

on:
  push:
    tags:
      - 'mac-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/mac-v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "No certificate provided, skipping import"
            exit 0
          fi

          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 -d > certificate.p12
          security import certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          # Set as default keychain and add to search list
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"

          # Allow codesign to access the key without prompting
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Clean up
          rm certificate.p12

          # Export keychain path and password for subsequent steps
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          # Verify certificate is accessible for code signing
          echo "Verifying certificate is accessible..."
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo "Certificate imported successfully"

      - name: Build universal app bundle
        env:
          CODESIGN_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          cd apps/mac

          # Build for x86_64
          echo "Building for x86_64..."
          xcodebuild -project mac.xcodeproj \
            -scheme mac \
            -configuration Release \
            -arch x86_64 \
            -derivedDataPath .build/x86_64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

          # Build for arm64
          echo "Building for arm64..."
          xcodebuild -project mac.xcodeproj \
            -scheme mac \
            -configuration Release \
            -arch arm64 \
            -derivedDataPath .build/arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

          # Find the built .app bundles
          X86_APP=$(find .build/x86_64 -name "mac.app" -type d | head -1)
          ARM_APP=$(find .build/arm64 -name "mac.app" -type d | head -1)

          echo "x86_64 app: $X86_APP"
          echo "arm64 app: $ARM_APP"

          # Copy arm64 app as base (preserves all resources, Info.plist, etc.)
          cp -R "$ARM_APP" Virtues.app

          # Create universal binary by merging both architectures
          echo "Creating universal binary..."
          lipo -create \
            "$X86_APP/Contents/MacOS/mac" \
            "$ARM_APP/Contents/MacOS/mac" \
            -output Virtues.app/Contents/MacOS/mac

          # Verify universal binary
          echo "Binary architectures:"
          lipo -info Virtues.app/Contents/MacOS/mac

          # Sign if certificate is available
          if [ -n "$CODESIGN_IDENTITY" ] && [ -n "$KEYCHAIN_PATH" ]; then
            echo "Signing app bundle with identity: $CODESIGN_IDENTITY"

            # Unlock keychain for this step
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

            # Verify certificate is still accessible
            echo "Available signing identities:"
            security find-identity -v -p codesigning "$KEYCHAIN_PATH"

            # Sign the entire .app bundle with entitlements
            codesign --force --deep \
                     --sign "$CODESIGN_IDENTITY" \
                     --keychain "$KEYCHAIN_PATH" \
                     --entitlements mac/mac.entitlements \
                     --options runtime \
                     --timestamp \
                     Virtues.app || { echo "ERROR: codesign failed!"; exit 1; }

            # Verify signature
            codesign --verify --verbose=4 Virtues.app || { echo "ERROR: signature verification failed!"; exit 1; }
            echo "App bundle signed successfully"
          else
            echo "No signing identity provided, app will be unsigned"
            echo "CODESIGN_IDENTITY: ${CODESIGN_IDENTITY:-<empty>}"
            echo "KEYCHAIN_PATH: ${KEYCHAIN_PATH:-<empty>}"
          fi

      - name: Create DMG
        run: |
          cd apps/mac

          VERSION="${{ steps.version.outputs.VERSION }}"

          # Create staging folder with app and Applications symlink
          echo "Creating DMG staging folder..."
          mkdir -p dmg-staging
          cp -R Virtues.app dmg-staging/
          ln -s /Applications dmg-staging/Applications

          # Create DMG from staging folder
          echo "Creating DMG..."
          hdiutil create \
            -volname "Virtues" \
            -srcfolder dmg-staging \
            -ov \
            -format UDZO \
            "Virtues-${VERSION}.dmg"

          # Cleanup staging
          rm -rf dmg-staging

          echo "DMG created: Virtues-${VERSION}.dmg"
          ls -la "Virtues-${VERSION}.dmg"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd apps/mac
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_FILE="Virtues-${VERSION}.dmg"

          # Check if we have notarization credentials
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_APP_PASSWORD" ]; then
            echo "No notarization credentials provided, skipping"
            exit 0
          fi

          # Only notarize if the app is signed
          if codesign -dv Virtues.app 2>&1 | grep -q "Authority"; then
            echo "Submitting DMG for notarization..."

            # Submit for notarization
            xcrun notarytool submit "$DMG_FILE" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait

            # Staple the notarization ticket to the DMG
            echo "Stapling notarization ticket..."
            xcrun stapler staple "$DMG_FILE"

            # Verify stapling
            xcrun stapler validate "$DMG_FILE"

            echo "Notarization and stapling complete!"
          else
            echo "App not signed, skipping notarization"
          fi

      - name: Copy installer script
        run: |
          # Copy the installer script (updated for DMG)
          cp apps/mac/Scripts/installer.sh installer.sh
          chmod +x installer.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Virtues for Mac v${{ steps.version.outputs.VERSION }}
          body: |
            ## Virtues for Mac v${{ steps.version.outputs.VERSION }}

            ### Installation

            #### Option 1: Download DMG (Recommended)
            1. Download `Virtues-${{ steps.version.outputs.VERSION }}.dmg`
            2. Double-click to mount
            3. Drag **Virtues** to your Applications folder
            4. Launch from Applications

            #### Option 2: Command Line Installer
            ```bash
            curl -sSL https://github.com/${{ github.repository }}/releases/latest/download/installer.sh | bash
            ```

            ### First Run
            1. Launch Virtues from Applications
            2. Click the menu bar icon
            3. Select "Pair with Virtues..."
            4. Enter your pairing code from the web app

            ### Features
            - Universal binary (Intel + Apple Silicon)
            - Menu bar app with status indicator
            - Automatic startup on login
            - Activity tracking (app focus events)
            - 5-minute batch uploads
            - Local SQLite queue for reliability

            ### Requirements
            - macOS 11.0 or later
            - Accessibility permissions (prompted on first run)
          files: |
            apps/mac/Virtues-${{ steps.version.outputs.VERSION }}.dmg
            installer.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare latest release files
        if: success()
        run: |
          cd apps/mac
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Copy DMG for latest tag
          cp "Virtues-${VERSION}.dmg" Virtues.dmg

      - name: Upload latest artifacts
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mac-latest
          name: Virtues for Mac (Latest)
          body: |
            This release is automatically updated with the latest stable version.
            Current version: v${{ steps.version.outputs.VERSION }}

            For specific versions, see [all releases](https://github.com/${{ github.repository }}/releases).
          files: |
            apps/mac/Virtues.dmg
            installer.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
